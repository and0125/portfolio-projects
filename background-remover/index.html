<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Background Remover</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .upload-section {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        background: #f8f9fa;
      }

      .upload-section:hover {
        border-color: #0056b3;
        background: #e9ecef;
      }

      #fileInput {
        display: none;
      }

      .upload-btn {
        background: #007bff;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
      }

      .upload-btn:hover {
        background: #0056b3;
      }

      .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      label {
        font-weight: bold;
        color: #555;
      }

      input[type="range"] {
        width: 150px;
      }

      .process-btn {
        background: #28a745;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
      }

      .process-btn:hover {
        background: #218838;
      }

      .process-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .result-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .result-item h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .image-container {
        position: relative;
        display: inline-block;
        margin-bottom: 15px;
      }

      .result-item img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .download-btn {
        background: #17a2b8;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .download-btn:hover {
        background: #138496;
      }

      .progress {
        margin: 20px 0;
        text-align: center;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: #007bff;
        width: 0%;
        transition: width 0.3s;
      }

      .checkerboard {
        background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
          linear-gradient(-45deg, #ccc 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #ccc 75%),
          linear-gradient(-45deg, transparent 75%, #ccc 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸš€ Astronaut Background Remover</h1>

      <div
        class="upload-section"
        onclick="document.getElementById('fileInput').click()"
      >
        <p>Click here to upload your astronaut images</p>
        <button class="upload-btn" type="button">Choose Files</button>
        <p style="margin-top: 10px; color: #666">
          Supports PNG, JPG, JPEG formats
        </p>
      </div>

      <input type="file" id="fileInput" multiple accept="image/*" />

      <div class="controls">
        <div class="control-group">
          <label for="tolerance">Color Tolerance:</label>
          <input type="range" id="tolerance" min="0" max="100" value="30" />
          <span id="toleranceValue">30</span>
        </div>

        <div class="control-group">
          <label for="feather">Edge Feathering:</label>
          <input type="range" id="feather" min="0" max="10" value="2" />
          <span id="featherValue">2</span>
        </div>

        <button class="process-btn" id="processBtn" disabled>
          Remove Backgrounds
        </button>
      </div>

      <div class="progress" id="progress" style="display: none">
        <p>Processing images...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <div class="results" id="results"></div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const processBtn = document.getElementById("processBtn");
      const toleranceSlider = document.getElementById("tolerance");
      const featherSlider = document.getElementById("feather");
      const toleranceValue = document.getElementById("toleranceValue");
      const featherValue = document.getElementById("featherValue");
      const progress = document.getElementById("progress");
      const progressFill = document.getElementById("progressFill");
      const results = document.getElementById("results");

      let selectedFiles = [];

      // Update slider values
      toleranceSlider.addEventListener("input", (e) => {
        toleranceValue.textContent = e.target.value;
      });

      featherSlider.addEventListener("input", (e) => {
        featherValue.textContent = e.target.value;
      });

      fileInput.addEventListener("change", (e) => {
        selectedFiles = Array.from(e.target.files);
        processBtn.disabled = selectedFiles.length === 0;

        if (selectedFiles.length > 0) {
          processBtn.textContent = `Remove Backgrounds (${selectedFiles.length} images)`;
        }
      });

      processBtn.addEventListener("click", processImages);

      function removeBackground(imageData, width, height, tolerance, feather) {
        const data = imageData.data;
        const newData = new Uint8ClampedArray(data);

        // Sample background color from corners
        const corners = [
          [0, 0],
          [width - 1, 0],
          [0, height - 1],
          [width - 1, height - 1],
        ];

        let bgR = 0,
          bgG = 0,
          bgB = 0;
        let validCorners = 0;

        corners.forEach(([x, y]) => {
          const idx = (y * width + x) * 4;
          if (idx < data.length) {
            bgR += data[idx];
            bgG += data[idx + 1];
            bgB += data[idx + 2];
            validCorners++;
          }
        });

        if (validCorners > 0) {
          bgR /= validCorners;
          bgG /= validCorners;
          bgB /= validCorners;
        }

        // Create mask for transparency
        const mask = new Array(width * height).fill(0);

        // First pass: mark pixels to remove
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const idx = (y * width + x) * 4;
            const r = data[idx];
            const g = data[idx + 1];
            const b = data[idx + 2];

            // Calculate color distance
            const distance = Math.sqrt(
              Math.pow(r - bgR, 2) + Math.pow(g - bgG, 2) + Math.pow(b - bgB, 2)
            );

            const normalizedDistance = distance / (Math.sqrt(3) * 255);

            if (normalizedDistance < tolerance / 100) {
              mask[y * width + x] = 1;
            }
          }
        }

        // Apply feathering if enabled
        if (feather > 0) {
          const featherMask = [...mask];

          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const idx = y * width + x;

              if (mask[idx] === 0) {
                // Check distance to nearest background pixel
                let minDist = feather + 1;

                for (let dy = -feather; dy <= feather; dy++) {
                  for (let dx = -feather; dx <= feather; dx++) {
                    const ny = y + dy;
                    const nx = x + dx;

                    if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                      const nIdx = ny * width + nx;
                      if (mask[nIdx] === 1) {
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        minDist = Math.min(minDist, dist);
                      }
                    }
                  }
                }

                if (minDist <= feather) {
                  const alpha = minDist / feather;
                  featherMask[idx] = 1 - alpha;
                }
              }
            }
          }

          // Apply feathered mask
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const idx = (y * width + x) * 4;
              const maskIdx = y * width + x;

              if (featherMask[maskIdx] > 0) {
                if (featherMask[maskIdx] === 1) {
                  newData[idx + 3] = 0; // Fully transparent
                } else {
                  newData[idx + 3] = Math.round(
                    255 * (1 - featherMask[maskIdx])
                  );
                }
              }
            }
          }
        } else {
          // Apply hard mask
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const idx = (y * width + x) * 4;
              const maskIdx = y * width + x;

              if (mask[maskIdx] === 1) {
                newData[idx + 3] = 0; // Transparent
              }
            }
          }
        }

        return new ImageData(newData, width, height);
      }

      async function processImages() {
        if (selectedFiles.length === 0) return;

        progress.style.display = "block";
        results.innerHTML = "";
        processBtn.disabled = true;

        const tolerance = parseInt(toleranceSlider.value);
        const feather = parseInt(featherSlider.value);

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const progressPercent = ((i + 1) / selectedFiles.length) * 100;
          progressFill.style.width = progressPercent + "%";

          try {
            const processedImage = await processImage(file, tolerance, feather);
            displayResult(file.name, processedImage);
          } catch (error) {
            console.error("Error processing", file.name, error);
          }
        }

        progress.style.display = "none";
        processBtn.disabled = false;
      }

      function processImage(file, tolerance, feather) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            canvas.width = img.width;
            canvas.height = img.height;

            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const processedData = removeBackground(
              imageData,
              canvas.width,
              canvas.height,
              tolerance,
              feather
            );

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(processedData, 0, 0);

            canvas.toBlob(resolve, "image/png");
          };
          img.onerror = reject;
          img.src = URL.createObjectURL(file);
        });
      }

      function displayResult(filename, blob) {
        const resultDiv = document.createElement("div");
        resultDiv.className = "result-item";

        const title = document.createElement("h3");
        title.textContent = filename.replace(/\.[^/.]+$/, "") + "_no_bg.png";

        const imageContainer = document.createElement("div");
        imageContainer.className = "image-container checkerboard";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(blob);
        img.alt = "Processed image";

        const downloadBtn = document.createElement("button");
        downloadBtn.className = "download-btn";
        downloadBtn.textContent = "Download PNG";
        downloadBtn.onclick = () => downloadImage(blob, filename);

        imageContainer.appendChild(img);
        resultDiv.appendChild(title);
        resultDiv.appendChild(imageContainer);
        resultDiv.appendChild(downloadBtn);

        results.appendChild(resultDiv);
      }

      function downloadImage(blob, originalFilename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = originalFilename.replace(/\.[^/.]+$/, "") + "_no_bg.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
